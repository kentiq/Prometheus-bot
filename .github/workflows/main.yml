name: Deploy Prometheus Bot

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Auto Deploy to VPS
    runs-on: ubuntu-latest

    steps:
    ###########################################################
    # 0. Checkout repository
    ###########################################################
    - name: Checkout repository
      uses: actions/checkout@v4

    ###########################################################
    # 1. Setup Node.js
    ###########################################################
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    ###########################################################
    # 2. Install dependencies locally (optional)
    ###########################################################
    - name: Install dependencies
      run: npm install

    ###########################################################
    # 3. Extract Webhook ID & Token from secret URL
    ###########################################################
    - name: Extract webhook parts safely
      id: hook
      run: |
        URL="${{ secrets.DEPLOY_WEBHOOK_URL }}"

        # Extract TOKEN (last segment)
        TOKEN=$(basename "$URL")

        # Extract ID (segment before last)
        ID=$(basename $(dirname "$URL"))

        echo "wid=$ID" >> $GITHUB_OUTPUT
        echo "wtoken=$TOKEN" >> $GITHUB_OUTPUT

        echo "Webhook ID = $ID"
        echo "Webhook Token = $TOKEN"

    ###########################################################
    # 4. Create the initial live message
    ###########################################################
    - name: Create live deploy message
      id: create_msg
      run: |
        echo "Creating initial webhook message..."

        RESPONSE=$(curl -s -H "Content-Type: application/json" \
          -X POST \
          -d "{
            \"embeds\": [{
              \"title\": \"üîç Initialisation du d√©ploiement‚Ä¶\",
              \"description\": \"Un nouveau commit a √©t√© d√©tect√©.\",
              \"color\": 5793266
            }]
          }" \
          "${{ secrets.DEPLOY_WEBHOOK_URL }}")

        MSG_ID=$(echo "$RESPONSE" | jq -r '.id')

        echo "msg_id=$MSG_ID" >> $GITHUB_OUTPUT
        echo "Created message ID = $MSG_ID"

    ###########################################################
    # Helper function: UPDATE MESSAGE via PATCH
    ###########################################################
    - name: Define PATCH helper
      id: patch
      run: |
        patch () {
          curl -s -X PATCH \
            -H "Content-Type: application/json" \
            -d "$1" \
            "https://discord.com/api/webhooks/${{ steps.hook.outputs.wid }}/${{ steps.hook.outputs.wtoken }}/messages/${{ steps.create_msg.outputs.msg_id }}"
        }
        echo "PATCH helper defined"

    ###########################################################
    # 5. Update message ‚Äì PULLING
    ###########################################################
    - name: Update message (Pulling)
      run: |
        curl -s -X PATCH \
          -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"üì• Pulling repository‚Ä¶\",
              \"color\": 5793266
            }]
          }" \
          "https://discord.com/api/webhooks/${{ steps.hook.outputs.wid }}/${{ steps.hook.outputs.wtoken }}/messages/${{ steps.create_msg.outputs.msg_id }}"

    ###########################################################
    # 6. Deploy on VPS (SSH)
    ###########################################################
    - name: Deploy on VPS via SSH
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          cd ${{ secrets.VPS_PROJECT_PATH }}
          git pull origin main
          npm install --omit=dev
          pm2 reload prometheus-bot

    ###########################################################
    # 7. Update message ‚Äì SUCCESS
    ###########################################################
    - name: Update message (Success)
      if: ${{ success() }}
      run: |
        curl -s -X PATCH \
          -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"üü© Deployment Success\",
              \"description\": \"Bot updated and PM2 reloaded successfully.\",
              \"color\": 5763719
            }]
          }" \
          "https://discord.com/api/webhooks/${{ steps.hook.outputs.wid }}/${{ steps.hook.outputs.wtoken }}/messages/${{ steps.create_msg.outputs.msg_id }}"

    ###########################################################
    # 8. Update message ‚Äì FAILURE
    ###########################################################
    - name: Update message (Error)
      if: ${{ failure() }}
      run: |
        curl -s -X PATCH \
          -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"‚ùå Deployment Failed\",
              \"description\": \"Une erreur est survenue pendant le pipeline GitHub Actions.\",
              \"color\": 15548997
            }]
          }" \
          "https://discord.com/api/webhooks/${{ steps.hook.outputs.wid }}/${{ steps.hook.outputs.wtoken }}/messages/${{ steps.create_msg.outputs.msg_id }}"
