name: Deploy Prometheus Bot

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: Auto Deploy to VPS
    runs-on: ubuntu-latest

    steps:

      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3. Install dependencies (local)
      - name: Install dependencies
        run: npm install

      ###########################################################
      # A) CREATE LIVE MESSAGE (POST)
      ###########################################################
      - name: Create live deploy message
        id: create_msg
        run: |
          echo "Sending initial deploy webhook..."

          RESPONSE=$(curl -s -H "Content-Type: application/json" \
            -X POST \
            -d "{\"content\": \"üü¶ **Deploy detected on Prometheus Bot**\", \"embeds\": [{\"title\": \"üîç Initialisation du d√©ploiement‚Ä¶\"}]}" \
            "${{ secrets.DEPLOY_WEBHOOK_URL }}")

          MSG_ID=$(echo "$RESPONSE" | jq -r '.id')
          WEBHOOK_TOKEN=$(echo "$RESPONSE" | jq -r '.token')

          echo "msg_id=$MSG_ID" >> $GITHUB_OUTPUT
          echo "webhook_token=$WEBHOOK_TOKEN" >> $GITHUB_OUTPUT

      ###########################################################
      # B) UPDATE MESSAGE ‚Äî PULLING
      ###########################################################
      - name: Update message (Pulling)
        run: |
          curl -s -X PATCH \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"üì• Pulling repository‚Ä¶\",\"color\": 5793266}]}" \
            "${{ secrets.DEPLOY_WEBHOOK_URL }}/messages/${{ steps.create_msg.outputs.msg_id }}/?wait=true"

      ###########################################################
      # C) DEPLOY OVER SSH
      ###########################################################
      - name: Deploy on VPS via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /var/www/kentiq-bot
            git pull origin main
            npm install --omit=dev
            pm2 reload prometheus-bot

      ###########################################################
      # D) UPDATE MESSAGE ‚Äî SUCCESS
      ###########################################################
      - name: Update message (Success)
        if: ${{ success() }}
        run: |
          curl -s -X PATCH \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"üü© Deployment Success\",\"description\": \"Bot updated and PM2 reloaded successfully.\",\"color\": 5763719}]}" \
            "${{ secrets.DEPLOY_WEBHOOK_URL }}/messages/${{ steps.create_msg.outputs.msg_id }}/?wait=true"

      ###########################################################
      # E) UPDATE MESSAGE ‚Äî FAILURE
      ###########################################################
      - name: Update message (Error)
        if: ${{ failure() }}
        run: |
          curl -s -X PATCH \
            -H "Content-Type: application/json" \
            -d "{\"embeds\": [{\"title\": \"‚ùå Deployment Failed\",\"description\": \"Error occurred during GitHub Actions pipeline.\",\"color\": 15548997}]}" \
            "${{ secrets.DEPLOY_WEBHOOK_URL }}/messages/${{ steps.create_msg.outputs.msg_id }}/?wait=true"
